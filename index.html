import React, { useState, useEffect, useRef } from 'react';

const OptimizedStencilCreator = () => {
  const [image, setImage] = useState(null);
  const [threshold, setThreshold] = useState(128);
  const [edgeDetection, setEdgeDetection] = useState(20);
  const [inverted, setInverted] = useState(false);
  const [lineThickness, setLineThickness] = useState(1);
  const originalCanvasRef = useRef(null);
  const processedCanvasRef = useRef(null);

  useEffect(() => {
    if (image) {
      const img = new Image();
      img.onload = () => {
        drawOriginalImage(img);
        createStencil(img);
      };
      img.src = URL.createObjectURL(image);
    }
  }, [image, threshold, edgeDetection, inverted, lineThickness]);

  const drawOriginalImage = (img) => {
    const canvas = originalCanvasRef.current;
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  };

  const createStencil = (img) => {
    const canvas = processedCanvasRef.current;
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;

    // Dibuja la imagen original
    ctx.drawImage(img, 0, 0);

    // Obtiene los datos de la imagen
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    // Aplica detección de bordes y umbral
    const edgeData = detectEdges(imageData);

    // Dibuja el stencil
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = inverted ? 'black' : 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = inverted ? 'white' : 'black';
    ctx.lineWidth = lineThickness;

    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const idx = (y * canvas.width + x) * 4;
        if (edgeData[idx] > threshold) {
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x + 1, y);
          ctx.stroke();
        }
      }
    }
  };

  const detectEdges = (imageData) => {
    const { width, height, data } = imageData;
    const output = new Uint8ClampedArray(data.length);
    
    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        const idx = (y * width + x) * 4;
        
        // Operador Sobel simplificado
        const gx = 
          -data[idx - 4 - width * 4] + data[idx + 4 - width * 4] +
          -2 * data[idx - 4] + 2 * data[idx + 4] +
          -data[idx - 4 + width * 4] + data[idx + 4 + width * 4];
        const gy = 
          -data[idx - width * 4 - 4] - 2 * data[idx - width * 4] - data[idx - width * 4 + 4] +
          data[idx + width * 4 - 4] + 2 * data[idx + width * 4] + data[idx + width * 4 + 4];

        const edge = Math.sqrt(gx * gx + gy * gy);
        output[idx] = output[idx + 1] = output[idx + 2] = edge * (edgeDetection / 10);
        output[idx + 3] = 255;
      }
    }

    return output;
  };

  const handleFileUpload = (e) => {
    if (e.target.files && e.target.files[0]) {
      setImage(e.target.files[0]);
    }
  };

  const downloadStencil = () => {
    const canvas = processedCanvasRef.current;
    const link = document.createElement('a');
    link.download = 'optimized_stencil.png';
    link.href = canvas.toDataURL();
    link.click();
  };

  return (
    <div className="flex flex-col items-center p-4 bg-gray-100 min-h-screen">
      <h1 className="text-3xl font-bold mb-6">Creador de Stencils Optimizado</h1>
      
      <div className="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md">
        <input 
          type="file" 
          accept="image/*" 
          onChange={handleFileUpload} 
          className="mb-4"
        />

        {image && (
          <>
            <div className="mb-4">
              <label className="block mb-2">Umbral: {threshold}</label>
              <input 
                type="range" 
                min="0" 
                max="255" 
                value={threshold} 
                onChange={(e) => setThreshold(Number(e.target.value))} 
                className="w-full"
              />
            </div>

            <div className="mb-4">
              <label className="block mb-2">Detección de Bordes: {edgeDetection}</label>
              <input 
                type="range" 
                min="1" 
                max="50" 
                value={edgeDetection} 
                onChange={(e) => setEdgeDetection(Number(e.target.value))} 
                className="w-full"
              />
            </div>

            <div className="mb-4">
              <label className="block mb-2">Grosor de Línea: {lineThickness}</label>
              <input 
                type="range" 
                min="0.5" 
                max="3" 
                step="0.1"
                value={lineThickness} 
                onChange={(e) => setLineThickness(Number(e.target.value))} 
                className="w-full"
              />
            </div>

            <div className="mb-4">
              <label className="flex items-center">
                <input 
                  type="checkbox" 
                  checked={inverted} 
                  onChange={(e) => setInverted(e.target.checked)}
                  className="mr-2"
                />
                Invertir Colores
              </label>
            </div>

            <div className="flex flex-col md:flex-row">
              <div className="md:w-1/2 pr-2">
                <h2 className="text-xl font-semibold mb-2">Imagen Original</h2>
                <canvas ref={originalCanvasRef} className="w-full border" />
              </div>
              <div className="md:w-1/2 pl-2">
                <h2 className="text-xl font-semibold mb-2">Stencil Procesado</h2>
                <canvas ref={processedCanvasRef} className="w-full border" />
              </div>
            </div>

            <button 
              onClick={downloadStencil} 
              className="w-full mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              Descargar Stencil
            </button>
          </>
        )}
      </div>
    </div>
  );
};

export default OptimizedStencilCreator;
