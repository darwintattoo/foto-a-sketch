<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darwin Prueba de Foto Realista a Sketch</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        h1, h2 { text-align: center; }
        .canvas-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .canvas-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .control {
            width: 200px;
        }
        label { display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>
    <h1>Darwin Prueba de Foto Realista a Sketch</h1>
    <input type="file" id="imageLoader" accept="image/*">
    <div class="canvas-container">
        <div class="canvas-item">
            <h2>Original</h2>
            <canvas id="original"></canvas>
        </div>
        <div class="canvas-item">
            <h2>Sketch</h2>
            <canvas id="sketch"></canvas>
        </div>
    </div>
    <div class="controls">
        <div class="control">
            <label for="edgeIntensity">Intensidad de Bordes: <span id="edgeIntensityValue">50</span></label>
            <input type="range" id="edgeIntensity" min="0" max="100" value="50">
        </div>
        <div class="control">
            <label for="contrast">Contraste: <span id="contrastValue">20</span></label>
            <input type="range" id="contrast" min="0" max="100" value="20">
        </div>
        <div class="control">
            <label for="brightness">Brillo: <span id="brightnessValue">0</span></label>
            <input type="range" id="brightness" min="-100" max="100" value="0">
        </div>
    </div>
    <script>
        const canvases = {
            original: document.getElementById('original'),
            sketch: document.getElementById('sketch')
        };
        const ctxs = Object.fromEntries(Object.entries(canvases).map(([k, v]) => [k, v.getContext('2d')]));

        const imageLoader = document.getElementById('imageLoader');
        const edgeIntensitySlider = document.getElementById('edgeIntensity');
        const contrastSlider = document.getElementById('contrast');
        const brightnessSlider = document.getElementById('brightness');

        let originalImage;

        imageLoader.addEventListener('change', handleImage, false);
        [edgeIntensitySlider, contrastSlider, brightnessSlider].forEach(slider => {
            slider.addEventListener('input', updateEffect);
        });

        function handleImage(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    console.log("Imagen cargada, dimensiones:", originalImage.width, "x", originalImage.height);
                    const resizedImage = resizeImage(originalImage, 1000);
                    Object.values(canvases).forEach(canvas => {
                        canvas.width = resizedImage.width;
                        canvas.height = resizedImage.height;
                    });
                    ctxs.original.drawImage(resizedImage, 0, 0);
                    console.log("Imagen dibujada en el canvas original");
                    updateEffect();
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        function resizeImage(img, maxDim) {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxDim) {
                    height *= maxDim / width;
                    width = maxDim;
                }
            } else {
                if (height > maxDim) {
                    width *= maxDim / height;
                    height = maxDim;
                }
            }

            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            console.log("Imagen redimensionada a", width, "x", height);
            return canvas;
        }

        function updateEffect() {
            if (!originalImage) return;

            console.log("Actualizando efecto");

            const edgeIntensity = parseInt(edgeIntensitySlider.value) / 100;
            const contrast = parseInt(contrastSlider.value) / 100;
            const brightness = parseInt(brightnessSlider.value);

            document.getElementById('edgeIntensityValue').textContent = edgeIntensitySlider.value;
            document.getElementById('contrastValue').textContent = contrastSlider.value;
            document.getElementById('brightnessValue').textContent = brightnessSlider.value;

            const imageData = ctxs.original.getImageData(0, 0, canvases.original.width, canvases.original.height);
            
            // Aplicar efecto de sketch
            const sketchData = createSketchEffect(imageData, edgeIntensity, contrast, brightness);
            ctxs.sketch.putImageData(sketchData, 0, 0);

            console.log("Efecto de sketch aplicado");
        }

        function createSketchEffect(imageData, edgeIntensity, contrast, brightness) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const result = new ImageData(new Uint8ClampedArray(data), width, height);
            const resultData = result.data;

            // Convertir a escala de grises y detectar bordes
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const gx = calculateGradient(data, width, x, y, [-1, 0, 1, -2, 0, 2, -1, 0, 1]);
                    const gy = calculateGradient(data, width, x, y, [-1, -2, -1, 0, 0, 0, 1, 2, 1]);
                    const g = Math.sqrt(gx * gx + gy * gy);
                    const value = 255 - g * edgeIntensity;
                    resultData[idx] = resultData[idx + 1] = resultData[idx + 2] = value;
                }
            }

            // Aplicar contraste y brillo
            applyContrastAndBrightness(resultData, contrast, brightness);

            return result;
        }

        function calculateGradient(data, width, x, y, kernel) {
            let sum = 0;
            for (let ky = -1; ky <= 1; ky++) {
                for (let kx = -1; kx <= 1; kx++) {
                    const idx = ((y + ky) * width + (x + kx)) * 4;
                    sum += data[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                }
            }
            return sum;
        }

        function applyContrastAndBrightness(data, contrast, brightness) {
            const factor = (259 * (contrast + 1)) / (255 * (1 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                for (let j = 0; j < 3; j++) {
                    let value = data[i + j];
                    value = factor * (value - 128) + 128; // Contraste
                    value += brightness; // Brillo
